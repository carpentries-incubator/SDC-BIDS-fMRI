<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Functional Neuroimaging Analysis in Python: Integrating Functional Data</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="assets/styles.css"><script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="manifest" href="site.webmanifest"><link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"></head><body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="assets/images/incubator-logo.svg"><abbr class="badge badge-light" title="This lesson is in the alpha phase, which means that it has been taught once and lesson authors are iterating on feedback." style="background-color: #FFC700; border-radius: 5px">
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#field-testing-alpha-stage" class="external-link alert-link" style="color: #383838">
            <i aria-hidden="true" class="icon" data-feather="alert-triangle" style="border-radius: 5px"></i>
            Alpha
          </a>
          <span class="visually-hidden">This lesson is in the alpha phase, which means that it has been taught once and lesson authors are iterating on feedback.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/04-integrating_functional_data.html';">Instructor View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Functional Neuroimaging Analysis in Python
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Functional Neuroimaging Analysis in Python
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><li><a class="dropdown-item" href="discuss.html">Discussion</a></li><li><a class="dropdown-item" href="reference.html">Glossary</a></li>
          </ul></li>
      </ul></div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled><input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset></form>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Functional Neuroimaging Analysis in Python
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 35%" class="percentage">
    35%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 35%" aria-valuenow="35" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/04-integrating_functional_data.html">Instructor View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->
      
            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-intro-and-preprocessing.html">1. Course Overview and Introduction</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-exploring-fmriprep.html">2. Exploring Preprocessed fMRI Data from fMRIPREP</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-basic_image_manipulation.html">3. Introduction to Image Manipulation using Nilearn</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        4. Integrating Functional Data
        </span>
      </button>
    </div><!--/div.accordion-header-->
        
    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#integrating-functional-data">Integrating Functional Data</a></li>
<li><a href="#fmri-dimensions">fMRI Dimensions</a></li>
<li><a href="#what-fmri-actually-represents">What fMRI actually represents</a></li>
<li><a href="#resampling">Resampling</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-data-cleaning-with-nilearn.html">5. Cleaning Confounders in your Data with Nilearn</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-apply-a-parcellation.html">6. Applying Parcellations to Resting State Data</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="07-functional-connectivity-analysis.html">7. Functional Connectivity Analysis</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="discuss.html">Discussion</a></li><li><a href="reference.html">Glossary</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width resources"><a href="aio.html">See all in one page</a>
            

            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">
            
            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="03-basic_image_manipulation.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="05-data-cleaning-with-nilearn.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="03-basic_image_manipulation.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Introduction to
        </a>
        <a class="chapter-link float-end" href="05-data-cleaning-with-nilearn.html" rel="next">
          Next: Cleaning Confounders... 
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Integrating Functional Data</h1>
        <p>Last updated on 2024-02-17 |
        
        <a href="https://github.com/carpentries-incubator/SDC-BIDS-fMRI/edit/main/episodes/04-integrating_functional_data.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
        
        
        
        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How is fMRI data represented</li>
<li>How can we access fMRI data along spatial and temporal
dimensions</li>
<li>How can we integrate fMRI and structural MRI together</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Extend the idea of slicing to 4 dimensions</li>
<li>Apply resampling to T1 images to combine them with fMRI data</li>
</ul></div>
</div>
</div>
</div>
</div>
<section id="integrating-functional-data"><h2 class="section-heading">Integrating Functional Data<a class="anchor" aria-label="anchor" href="#integrating-functional-data"></a>
</h2>
<hr class="half-width"><p>So far most of our work has been examining anatomical images - the
reason being is that it provides a nice visual way of exploring the
effects of data manipulation and visualization is easy. In practice, you
will most likely not analyze anatomical data using <code>nilearn</code>
since there are other tools that are better suited for that kind of
analysis (freesurfer, connectome-workbench, mindboggle, etc…).</p>
<p>In this notebook we’ll finally start working with functional MR data
- the modality of interest in this workshop. First we’ll cover some
basics about how the data is organized (similar to T1s but slightly more
complex), and then how we can integrate our anatomical and functional
data together using tools provided by <code>nilearn</code></p>
<p>Functional data consists of full 3D brain volumes that are
<em>sampled</em> at multiple time points. Therefore you have a sequence
of 3D brain volumes, stepping through sequences is stepping through time
and therefore time is our 4th dimension! Here’s a visualization to make
this concept more clear:</p>
<figure><img src="fig/4D_array.png" class="img-responsive figure mx-auto d-block" alt="4D Array Representation"></figure><p>Each index along the 4th dimensions (called TR for “Repetition Time”,
or Sample) is a full 3D scan of the brain. Pulling out volumes from
4-dimensional images is similar to that of 3-dimensional images except
you’re now dealing with:</p>
<p><code> nimg.slicer[x,y,z,time] </code>!</p>
<p>Let’s try a couple of examples to familiarize ourselves with dealing
with 4D images. But first, let’s pull some functional data using
PyBIDS!</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt <span class="co">#to enable plotting within notebook</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">from</span> nilearn <span class="im">import</span> image <span class="im">as</span> nimg</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">from</span> nilearn <span class="im">import</span> plotting <span class="im">as</span> nplot</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="im">from</span> bids.layout <span class="im">import</span> BIDSLayout</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code></pre>
</div>
<p>These are the usual imports. Let’s now pull some structural
<em>and</em> functional data using pyBIDS.</p>
<p>We’ll be using functional files in MNI space rather than T1w space.
Recall, that MNI space data is data that was been warped into standard
space. These are the files you would typically use for a group-level
functional imaging analysis!</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>fmriprep_dir <span class="op">=</span> <span class="st">'../data/ds000030/derivatives/fmriprep/'</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>layout<span class="op">=</span>BIDSLayout(fmriprep_dir, validate<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>                  config<span class="op">=</span>[<span class="st">'bids'</span>,<span class="st">'derivatives'</span>])</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>T1w_files <span class="op">=</span> layout.get(subject<span class="op">=</span><span class="st">'10788'</span>,</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>                       datatype<span class="op">=</span><span class="st">'anat'</span>, desc<span class="op">=</span><span class="st">'preproc'</span>,</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>                       space<span class="op">=</span><span class="st">'MNI152NLin2009cAsym'</span>,</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>                       extension<span class="op">=</span><span class="st">"nii.gz"</span>,</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>                      return_type<span class="op">=</span><span class="st">'file'</span>)</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>brainmask_files <span class="op">=</span> layout.get(subject<span class="op">=</span><span class="st">'10788'</span>,</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>                             datatype<span class="op">=</span><span class="st">'anat'</span>, suffix<span class="op">=</span><span class="st">'mask'</span>,</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>                             desc<span class="op">=</span><span class="st">'brain'</span>,</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>                             space<span class="op">=</span><span class="st">'MNI152NLin2009cAsym'</span>,</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>                             extension<span class="op">=</span><span class="st">"nii.gz"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>                            return_type<span class="op">=</span><span class="st">'file'</span>)</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>func_files <span class="op">=</span> layout.get(subject<span class="op">=</span><span class="st">'10788'</span>,</span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>                        datatype<span class="op">=</span><span class="st">'func'</span>, desc<span class="op">=</span><span class="st">'preproc'</span>,</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>                       space<span class="op">=</span><span class="st">'MNI152NLin2009cAsym'</span>,</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>                       extension<span class="op">=</span><span class="st">"nii.gz"</span>,</span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>                       return_type<span class="op">=</span><span class="st">'file'</span>)</span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>func_mask_files <span class="op">=</span> layout.get(subject<span class="op">=</span><span class="st">'10788'</span>,</span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>                             datatype<span class="op">=</span><span class="st">'func'</span>, suffix<span class="op">=</span><span class="st">'mask'</span>,</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>                             desc<span class="op">=</span><span class="st">'brain'</span>,</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>                             space<span class="op">=</span><span class="st">'MNI152NLin2009cAsym'</span>,</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>                             extension<span class="op">=</span><span class="st">"nii.gz"</span>,</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>                            return_type<span class="op">=</span><span class="st">'file'</span>)</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>func_mni <span class="op">=</span> func_files[<span class="dv">0</span>]</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>func_mni_img <span class="op">=</span> nimg.load_img(func_mni)</span></code></pre>
</div>
</section><section id="fmri-dimensions"><h2 class="section-heading">fMRI Dimensions<a class="anchor" aria-label="anchor" href="#fmri-dimensions"></a>
</h2>
<hr class="half-width"><p>First note that fMRI data contains both spatial dimensions (x,y,z)
and a temporal dimension (t). This would mean that we require 4
dimensions in order to represent our data. Let’s take a look at the
shape of our data matrix to confirm this intuition:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>func_mni_img.shape</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(65, 77, 49, 152)</code></pre>
</div>
<p>Notice that the Functional MR scan contains <em>4 dimensions</em>.
This is in the form of <span class="math inline">\((x,y,z,t)\)</span>,
where <span class="math inline">\(t\)</span> is time. We can use slicer
as usual where instead of using 3 dimensions we use 4.</p>
<p>For example:</p>
<p><code> func.slicer[x,y,z] </code></p>
<p>vs.</p>
<p><code> func.slicer[x,y,z,t] </code></p>
<div id="exercise" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise" class="callout-inner">
<h3 class="callout-title">Exercise<a class="anchor" aria-label="anchor" href="#exercise"></a>
</h3>
<div class="callout-content">
<p>Try pulling out the 5th TR and visualizing it using
<code>nplot.view_img</code>.</p>
<p>Remember that <code>nplot.view_img</code> provides an interactive
view of the brain, try scrolling around!</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">Show me the solution</h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">#Pull the 5th TR</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>func_vol5 <span class="op">=</span> func_mni_img.slicer[:,:,:,<span class="dv">4</span>]</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>nplot.view_img(func_vol5)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>You may also use <code>nplot.plot_epi</code>. <code>plot_epi</code>
is exactly the same as <code>plot_anat</code> except it displays using
colors that make more sense for functional images…</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co">#Pull the 5th TR</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>nplot.plot_epi(func_vol5)</span></code></pre>
</div>
<figure><img src="fig/fmri_data.png" class="img-responsive figure mx-auto d-block" alt="Visual of fMRI EPI Data"></figure></section><section id="what-fmri-actually-represents"><h2 class="section-heading">What fMRI actually represents<a class="anchor" aria-label="anchor" href="#what-fmri-actually-represents"></a>
</h2>
<hr class="half-width"><p>We’ve represented fMRI as a snapshot of MR signal over multiple
timepoints. This is a useful way of understanding the organization of
fMRI, however it isn’t typically how we think about the data when we
analyze fMRI data. fMRI is typically thought of as
<strong>time-series</strong> data. We can think of each voxel (x,y,z
coordinate) as having a time-series of length T. The length T represents
the number of volumes/timepoints in the data. Let’s pick an example
voxel and examine its time-series using
<code>func_mni_img.slicer</code>:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co">#Pick one voxel at coordinate (60,45,88)</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>single_vox <span class="op">=</span> func_mni_img.slicer[<span class="dv">59</span>:<span class="dv">60</span>,<span class="dv">45</span>:<span class="dv">46</span>,<span class="dv">30</span>:<span class="dv">31</span>,:].get_data()</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>single_vox.shape</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(1, 1, 1, 152)</code></pre>
</div>
<p>As you can see we have 1 element in (x,y,z) dimension representing a
single voxel. In addition, we have 152 elements in the fourth dimension.
In totality, this means we have a single voxel with 152 timepoints.
Dealing with 4 dimensional arrays are difficult to work with - since we
have a single element across the first 3 dimensions we can squish this
down to a 1 dimensional array with 152 time-points. We no longer need
the first 3 spatial dimensions since we’re only looking at one voxel and
don’t need (x,y,z) anymore:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>single_vox <span class="op">=</span> single_vox.flatten()</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>single_vox.shape</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(152,)</code></pre>
</div>
<p>Here we’ve pulled out a voxel at a specific coordinate at every
single time-point. This voxel has a single value for each timepoint and
therefore is a time-series. We can visualize this time-series signal by
using a standard python plotting library. We won’t go into too much
detail about python plotting, the intuition about what the data looks
like is what is most important:</p>
<p>First let’s import the standard python plotting library
<code>matplotlib</code>:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Make an array counting from 0 --&gt; 152, this will be our x-axis</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>x_axis <span class="op">=</span> np.arange(<span class="dv">0</span>, single_vox.shape[<span class="dv">0</span>])</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co"># Plot our x and y data, the 'k' just specifies the line color to be black</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>plt.plot( x_axis, single_vox, <span class="st">'k'</span>)</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="co"># Label our axes</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>plt.xlabel(<span class="st">'Timepoint'</span>)</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>plt.ylabel(<span class="st">'Signal Value'</span>)</span></code></pre>
</div>
<figure><img src="fig/timeseries.png" class="img-responsive figure mx-auto d-block" alt="Example fMRI Timeseries"></figure><p>As you can see from the image above, fMRI data really is just a
signal per voxel over time!</p>
</section><section id="resampling"><h2 class="section-heading">Resampling<a class="anchor" aria-label="anchor" href="#resampling"></a>
</h2>
<hr class="half-width"><p>Recall from our introductory exploration of neuroimaging data:</p>
<ul><li>T1 images are typically composed of voxels that are 1x1x1 in
dimension</li>
<li>Functional images are typically composed of voxels that are 4x4x4 in
dimension</li>
</ul><p>If we’d like to overlay our functional on top of our T1 (for
visualization purposes, or analyses), then we need to match the size of
the voxels!</p>
<p>Think of this like trying to overlay a 10x10 JPEG and a 20x20 JPEG on
top of each other. To get perfect overlay we need to resize (or more
accurately <em>resample</em>) our JPEGs to match!</p>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout1"></a>
</h3>
<div class="callout-content">
<p>Resampling is a method of interpolating in between data-points. When
we stretch an image we need to figure out what goes in the spaces that
are created via stretching - resampling does just that. In fact,
resizing any type of image is actually just resampling to new
dimensions.</p>
</div>
</div>
</div>
<p>Let’s resampling some MRI data using nilearn.</p>
<p><strong>Goal</strong>: Match the dimensions of the structural image
to that of the functional image</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># Files we'll be using (Notice that we're using _space-MNI...</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="co"># which means they are normalized brains)</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>T1_mni <span class="op">=</span> T1w_files[<span class="dv">0</span>]</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>T1_mni_img <span class="op">=</span> nimg.load_img(T1_mni)</span></code></pre>
</div>
<p>Let’s take a quick look at the sizes of both our functional and
structural files:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="bu">print</span>(T1_mni_img.shape)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="bu">print</span>(func_mni_img.shape)</span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>(193, 229, 193)
(60, 77, 49, 152)</code></pre>
</div>
<p>Taking a look at the spatial dimensions (first three dimensions), we
can see that the number of voxels in the T1 image does not match that of
the fMRI image. This is because the fMRI data (which has less voxels) is
a <em>lower resolution image</em>. We either need to <em>upsample</em>
our fMRI image to match that of the T1 image, or we need to
<em>downsample</em> our T1 image to match that of the fMRI image.
Typically, since the fMRI data is the one we’d like to ultimately use
for analysis, we would leave it alone and downsample our T1 image. The
reason being is that <em>resampling</em> requires interpolating values
which may contaminate our data with artifacts. We don’t mind having
artifacts in our T1 data (for visualization purposes) since the fMRI
data is the one actually being analyzed.</p>
<p>Resampling in nilearn is as easy as telling it which image you want
to sample and what the target image is.</p>
<p>Structure of function:</p>
<p><code>nimg.resample_to_img(source_img,target_img,interpolation)</code></p>
<ul><li>
<code>source_img</code> = the image you want to sample</li>
<li>
<code>target_img</code> = the image you wish to <em>resample
to</em>
</li>
<li>
<code>interpolation</code> = the method of interpolation</li>
</ul><div id="callout2" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout<a class="anchor" aria-label="anchor" href="#callout2"></a>
</h3>
<div class="callout-content">
<p>A note on <strong>interpolation</strong> nilearn supports 3 types of
interpolation, the one you’ll use depends on the type of data you’re
resampling!</p>
<ol style="list-style-type: decimal"><li>
<strong>continuous</strong> - Interpolate but maintain some edge
features. Ideal for structural images where edges are well-defined. Uses
<span class="math inline">\(3^\\text{rd}\)</span>-order spline
interpolation.</li>
<li>
<strong>linear (default)</strong> - Interpolate uses a combination
of neighbouring voxels - will blur. Uses trilinear interpolation.</li>
<li>
<strong>nearest</strong> - matches value of closest voxel (majority
vote from neighbours). This is ideal for masks which are binary since it
will preserve the 0’s and 1’s and will not produce in-between values
(ex: 0.342). Also ideal for numeric labels where values are 0,1,2,3…
(parcellations). Uses nearest-neighbours interpolation with majority
vote.</li>
</ol></div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co">#Try playing around with methods of interpolation</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="co">#options: 'linear','continuous','nearest'</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>resamp_t1 <span class="op">=</span> nimg.resample_to_img(source_img<span class="op">=</span>T1_mni_img,target_img<span class="op">=</span>func_mni_img,interpolation<span class="op">=</span><span class="st">'continuous'</span>)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="bu">print</span>(resamp_t1.shape)</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="bu">print</span>(func_mni_img.shape)</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>nplot.plot_anat(resamp_t1)</span></code></pre>
</div>
<figure><img src="fig/downsample_t1.png" class="img-responsive figure mx-auto d-block" alt="Downsampled T1"></figure><p>Now that we’ve explored the idea of resampling let’s do a cumulative
exercise bringing together ideas from resampling and basic image
operations.</p>
<div id="exercise-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise-1" class="callout-inner">
<h3 class="callout-title">Exercise<a class="anchor" aria-label="anchor" href="#exercise-1"></a>
</h3>
<div class="callout-content">
<p>Using <strong>Native</strong> T1 and <strong>T1w</strong> resting
state functional do the following:</p>
<ol style="list-style-type: decimal"><li>Resample the T1 image to resting state size</li>
<li>Replace the brain in the T1 image with the first frame of the
resting state brain</li>
</ol><div class="section level3">
<h3 id="files-well-need">Files we’ll need<a class="anchor" aria-label="anchor" href="#files-well-need"></a></h3>
<div class="section level4">
<h4 id="structural-files">Structural Files<a class="anchor" aria-label="anchor" href="#structural-files"></a></h4>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co">#T1 image</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>ex_t1 <span class="op">=</span> nimg.load_img(T1w_files[<span class="dv">0</span>])</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="co">#mask file</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>ex_t1_bm <span class="op">=</span> nimg.load_img(brainmask_files[<span class="dv">0</span>])</span></code></pre>
</div>
</div>
<div class="section level4">
<h4 id="functional-files">Functional Files<a class="anchor" aria-label="anchor" href="#functional-files"></a></h4>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co">#This is the pre-processed resting state data that hasn't been standardized</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>ex_func <span class="op">=</span> nimg.load_img(func_files[<span class="dv">0</span>])</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="co">#This is the associated mask for the resting state image.</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>ex_func_bm <span class="op">=</span> nimg.load_img(func_mask_files[<span class="dv">0</span>])</span></code></pre>
</div>
<p>The first step is to remove the brain from the T1 image so that we’re
left with a hollow skull. This can be broken down into 2 steps:</p>
<ol style="list-style-type: decimal"><li>Invert the mask so that all 1’s become 0’s and all 0’s become
1’s</li>
</ol><div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># Invert the T1 mask</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>invert_mask <span class="op">=</span> nimg.math_img(<span class="st">'??'</span>, a<span class="op">=</span>??)</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>nplot.plot_anat(??)</span></code></pre>
</div>
<figure><img src="fig/exercise_inverted_mask.png" class="img-responsive figure mx-auto d-block" alt="Episode 04 Exercise Inverted Mask"></figure><ol start="2" style="list-style-type: decimal"><li>Apply the mask onto the T1 image, this will effectively remove the
brain</li>
</ol><div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># Apply the mask onto the T1 image</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>hollow_skull <span class="op">=</span> nimg.math_img(<span class="st">"??"</span>, a<span class="op">=</span>??, b<span class="op">=</span>??)</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>nplot.plot_anat(??)</span></code></pre>
</div>
<figure><img src="fig/exercise_hollow_skull.png" class="img-responsive figure mx-auto d-block" alt="Episode 04 Exercise Hollow Skull"></figure><p>Our brain is now missing!</p>
<p>Next we need to <em>resize</em> the hollow skull image to the
dimensions of our resting state image. This can be done using resampling
as we’ve done earlier in this episode.</p>
<p>What kind of interpolation would we need to perform here? Recall
that:</p>
<ul><li>
<strong>Continuous</strong>: Tries to maintain the edges of the
image</li>
<li>
<strong>Linear</strong>: Resizes the image but also blurs it a
bit</li>
<li>
<strong>Nearest</strong>: Sets values to the closest neighbouring
values</li>
</ul><div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co">#Resample the T1 to the size of the functional image!</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>resamp_skull <span class="op">=</span> nimg.resample_to_img(source_img<span class="op">=</span>??,</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>                                 target_img<span class="op">=</span>??,</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>                                 interpolation<span class="op">=</span><span class="st">'??'</span>)</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>nplot.plot_anat(resamp_skull)</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="bu">print</span>(resamp_skull.shape)</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="bu">print</span>(ex_func.shape)</span></code></pre>
</div>
<figure><img src="fig/exercise_resampled_hollow_skull.png" class="img-responsive figure mx-auto d-block" alt="Episode 04 Exercise Resampled Hollow Skull"></figure><p>We now have a skull missing the structural T1 brain that is resized
to match the dimensions of the EPI image.</p>
<p>The final steps are to:</p>
<ol style="list-style-type: decimal"><li>Pull the first volume from the functional image</li>
<li>Place the functional image head into the hollow skull that we’ve
created</li>
</ol><p>Since a functional image is 4-Dimensional, we’ll need to pull the
first volume to work with. This is because the structural image is
3-dimensional and operations will fail if we try to mix 3D and 4D
data.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co">#Let's visualize the first volume of the functional image:</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>first_vol <span class="op">=</span> ex_func.slicer[??, ??, ??, ??]</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>nplot.plot_epi(first_vol)</span></code></pre>
</div>
<figure><img src="fig/exercise_fmri.png" class="img-responsive figure mx-auto d-block" alt="Episode 04 Exercise fMRI"></figure><p>As shown in the figure above, the image has some “signal” outside of
the brain. In order to place this within the now brainless head we made
earlier, we need to mask out the functional MR data as well!</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co">#Mask the first volume using ex_func_bm</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>masked_func <span class="op">=</span> nimg.math_img(<span class="st">'??'</span>, a<span class="op">=</span>??, b<span class="op">=</span>??)</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>nplot.plot_epi(masked_func)</span></code></pre>
</div>
<figure><img src="fig/exercise_masked_fmri.png" class="img-responsive figure mx-auto d-block" alt="Episode 04 Exercise Masked fMRI"></figure><p>The final step is to stick this data into the head of the T1 data.
Since the hole in the T1 data is represented as <span class="math inline">\(0\)</span>’s. We can add the two images together
to place the functional data into the void:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co">#Now overlay the functional image on top of the anatomical</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>combined_img <span class="op">=</span> nimg.math_img(??)</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>nplot.plot_anat(combined_img)</span></code></pre>
</div>
<figure><img src="fig/exercise_complete.png" class="img-responsive figure mx-auto d-block" alt="Episode 04 Exercise Complete"></figure></div>
</div>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">Show me the solution</h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co"># Invert the mask</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>invert_mask <span class="op">=</span> nimg.math_img(<span class="st">'1-a'</span>, a<span class="op">=</span>ex_t1_bm)</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>nplot.plot_anat(invert_mask)</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a><span class="co"># Apply the mask onto the T1 image</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>hollow_skull <span class="op">=</span> nimg.math_img(<span class="st">"a*b"</span>, a<span class="op">=</span>ex_t1, b<span class="op">=</span>invert_mask)</span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>nplot.plot_anat(hollow_skull)</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a><span class="co">#Resample the T1 to the size of the functional image!</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>resamp_skull <span class="op">=</span> nimg.resample_to_img(source_img<span class="op">=</span>hollow_skull,</span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>                                 target_img<span class="op">=</span>ex_func,</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>                                 interpolation<span class="op">=</span><span class="st">'continuous'</span>)</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>nplot.plot_anat(resamp_skull)</span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a><span class="bu">print</span>(resamp_skull.shape)</span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a><span class="bu">print</span>(ex_func.shape)</span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a><span class="co">#Let's visualize the first volume of the functional image:</span></span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a>first_vol <span class="op">=</span> ex_func.slicer[:,:,:,<span class="dv">0</span>]</span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a>nplot.plot_epi(first_vol)</span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a>masked_func <span class="op">=</span> nimg.math_img(<span class="st">'a*b'</span>, a<span class="op">=</span>first_vol, b<span class="op">=</span>ex_func_bm)</span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a>nplot.plot_epi(masked_func)</span>
<span id="cb26-23"><a href="#cb26-23" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" tabindex="-1"></a><span class="co">#Now overlay the functional image on top of the anatomical</span></span>
<span id="cb26-25"><a href="#cb26-25" tabindex="-1"></a>combined_img <span class="op">=</span> nimg.math_img(<span class="st">'a+b'</span>,</span>
<span id="cb26-26"><a href="#cb26-26" tabindex="-1"></a>                             a<span class="op">=</span>resamp_skull, </span>
<span id="cb26-27"><a href="#cb26-27" tabindex="-1"></a>                             b<span class="op">=</span>masked_func)</span>
<span id="cb26-28"><a href="#cb26-28" tabindex="-1"></a>nplot.plot_anat(combined_img)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<p>This doesn’t actually achieve anything useful in practice. However it
has hopefully served to get you more comfortable with the idea of
resampling and performing manipulations on MRI data!</p>
<p>In this section we explored functional MR imaging. Specifically we
covered:</p>
<ol style="list-style-type: decimal"><li>How the data in a fMRI scan is organized - with the additional
dimension of timepoints</li>
<li>How we can integrate functional MR images to our structural image
using resampling</li>
<li>How we can just as easily manipulate functional images using
<code>nilearn</code>
</li>
</ol><p>Now that we’ve covered all the basics, it’s time to start working on
data processing using the tools that we’ve picked up.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul><li>fMRI data is represented by spatial (x,y,z) and temporal (t)
dimensions, totalling 4 dimensions</li>
<li>fMRI data is at a lower resolution than structural data. To be able
to combine data requires resampling your data</li>
</ul></div>
</div>
</div>
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="03-basic_image_manipulation.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="05-data-cleaning-with-nilearn.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="03-basic_image_manipulation.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: Introduction to
        </a>
        <a class="chapter-link float-end" href="05-data-cleaning-with-nilearn.html" rel="next">
          Next: Cleaning Confounders... 
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/carpentries-incubator/SDC-BIDS-fMRI/edit/main/episodes/04-integrating_functional_data.md" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/carpentries-incubator/SDC-BIDS-fMRI/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/carpentries-incubator/SDC-BIDS-fMRI/" class="external-link">Source</a></p>
				<p><a href="https://github.com/carpentries-incubator/SDC-BIDS-fMRI/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.3" class="external-link">sandpaper (0.16.3)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.4" class="external-link">pegboard (0.7.4)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.1" class="external-link">varnish (1.0.1)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://carpentries-incubator.github.io/SDC-BIDS-fMRI/04-integrating_functional_data.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "Integrating Functional Data",
  "creativeWorkStatus": "active",
  "url": "https://carpentries-incubator.github.io/SDC-BIDS-fMRI/04-integrating_functional_data.html",
  "identifier": "https://carpentries-incubator.github.io/SDC-BIDS-fMRI/04-integrating_functional_data.html",
  "dateCreated": "2024-02-18",
  "dateModified": "2024-02-17",
  "datePublished": "2024-04-02"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code --></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

